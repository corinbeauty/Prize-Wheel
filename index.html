<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Corin Beauty - å®˜æ–¹å¹¸é‹è½‰ç›¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #fff5f7; }
        
        /* åŸºç¤è½‰ç›¤å®¹å™¨ */
        .wheel-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
        }
        
        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid #fce7f3;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
            background: #fff;
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.2);
        }

        /* è½‰ç›¤æŒ‡é‡ */
        .pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background: #ec4899;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            z-index: 50;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        /* ä¸­é–“åœ“éˆ• */
        .center-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: white;
            border: 4px solid #ec4899;
            border-radius: 50%;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .modal-active { display: flex !important; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .loading-spinner {
            border: 3px solid rgba(236, 72, 153, 0.1);
            border-top: 3px solid #ec4899;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .ai-bubble {
            background: #fff;
            border: 2px solid #fbcfe8;
            border-radius: 1.5rem;
            padding: 1rem;
            margin-top: 1rem;
            position: relative;
            font-size: 0.875rem;
            color: #4b5563;
            text-align: left;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ç‹€æ…‹é®ç½©å±¤ -->
    <div id="status-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-6 text-center">
        <div id="loading-ui">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-pink-600 font-medium italic">åˆå§‹åŒ– Corin Beauty è½‰ç›¤ç³»çµ±...</p>
        </div>
        <div id="error-ui" class="hidden">
            <div class="text-red-500 text-4xl mb-4">âš ï¸</div>
            <h2 class="text-lg font-bold text-gray-800 mb-2">é€£ç·šç™¼ç”ŸéŒ¯èª¤</h2>
            <p id="error-message" class="text-sm text-gray-600 mb-6 px-4"></p>
            <button onclick="location.reload()" class="bg-pink-600 text-white px-8 py-2 rounded-full text-sm font-bold shadow-lg">é‡æ–°æ•´ç†</button>
        </div>
    </div>

    <!-- ä¸­ççµæœå½ˆçª— (å« AI é¡§å•) -->
    <div id="prize-modal" class="fixed inset-0 bg-black/70 z-[150] hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white rounded-[2.5rem] p-8 max-w-xs w-full text-center shadow-2xl">
            <div id="prize-icon" class="text-6xl mb-4">ğŸ</div>
            <div class="text-[10px] font-bold text-pink-500 uppercase tracking-widest mb-1">Congratulations</div>
            <h3 id="modal-prize-name" class="text-xl font-black text-gray-800 mb-4 leading-tight"></h3>
            
            <div class="bg-gray-50 rounded-2xl p-4 mb-4 border border-gray-100">
                <p id="modal-prize-id" class="text-[10px] text-gray-400 font-mono mb-1"></p>
                <p id="modal-prize-exp" class="text-[11px] text-rose-500 font-bold"></p>
            </div>

            <div id="ai-consultant-section" class="hidden">
                <div id="ai-loading" class="flex flex-col items-center justify-center py-4 hidden">
                    <div class="loading-spinner !w-6 !h-6 mb-2"></div>
                    <span class="text-[10px] text-pink-400 font-bold">é¡§å•è¦åŠƒå»ºè­°ä¸­...</span>
                </div>
                <div id="ai-response" class="ai-bubble hidden"></div>
            </div>
            
            <div class="flex flex-col gap-2 mt-4">
                <button id="btn-ask-ai" onclick="getBeautyAdvice()" class="w-full py-3 bg-white border-2 border-pink-200 text-pink-500 rounded-xl font-bold text-sm shadow-sm active:scale-95 transition-all flex items-center justify-center gap-2">
                    âœ¨ è«®è©¢ AI ç¾é¡é¡§å•
                </button>
                <button onclick="closeModal('prize-modal')" class="w-full py-3 bg-pink-600 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all">
                    æ”¶ä¸‹çé …
                </button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å“¡é©—è­‰å½ˆçª— -->
    <div id="admin-modal" class="fixed inset-0 bg-black/80 z-[120] hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white rounded-[2rem] p-8 max-w-xs w-full text-center shadow-2xl">
            <h3 class="text-xl font-black text-gray-800 mb-4">ç®¡ç†å“¡é©—è­‰</h3>
            <input type="password" id="admin-pass" class="w-full border-2 border-pink-100 rounded-xl px-4 py-3 mb-4 text-center focus:border-pink-500 outline-none" placeholder="è¼¸å…¥å¯†ç¢¼">
            <div class="flex gap-2">
                <button onclick="closeModal('admin-modal')" class="flex-1 py-3 bg-gray-100 text-gray-400 rounded-xl font-bold">å–æ¶ˆ</button>
                <button onclick="verifyAdmin()" class="flex-1 py-3 bg-pink-600 text-white rounded-xl font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨è¨Šæ¯å½ˆçª— -->
    <div id="msg-modal" class="fixed inset-0 bg-black/40 z-[150] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 max-w-xs w-full text-center shadow-2xl">
            <p id="msg-text" class="text-gray-800 font-bold mb-6"></p>
            <button onclick="closeModal('msg-modal')" class="w-full py-3 bg-gray-800 text-white rounded-xl font-bold">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- å…Œæ›ç¢ºèªå½ˆçª— -->
    <div id="redeem-confirm-modal" class="fixed inset-0 bg-black/60 z-[110] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] p-8 max-w-xs w-full text-center shadow-2xl">
            <div class="w-16 h-16 bg-pink-50 text-pink-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ğŸ«</div>
            <h3 class="text-xl font-black text-gray-800 mb-2">ç¢ºèªå…Œæ›ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mb-6">è«‹ç¢ºèªæ‚¨å·²åœ¨æ«ƒæª¯ç¾å ´ï¼Œé»æ“Šå¾Œçé …å°‡æ¨™è¨»ç‚ºå·²å…Œæ›ã€‚</p>
            <div class="flex gap-2">
                <button onclick="closeModal('redeem-confirm-modal')" class="flex-1 py-4 bg-gray-100 text-gray-500 rounded-2xl text-sm font-bold">å–æ¶ˆ</button>
                <button id="confirm-redeem-btn" class="flex-1 py-4 bg-pink-600 text-white rounded-2xl text-sm font-bold">ç¢ºå®šå…Œæ›</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å¡ç‰‡å…§å®¹ -->
    <div id="main-card" class="bg-white rounded-[2.5rem] shadow-2xl p-6 w-full max-sm border border-pink-50 flex flex-col min-h-[620px] relative">
        <div class="flex justify-between items-center mb-6">
            <div class="flex bg-gray-100 p-1 rounded-xl">
                <button id="tab-game" onclick="switchTab('game')" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow-sm text-pink-600">å¹¸é‹è½‰ç›¤</button>
                <button id="tab-history" onclick="switchTab('history')" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-400">ä¸­çç´€éŒ„</button>
            </div>
            <div id="chance-dots" class="flex space-x-1"></div>
        </div>

        <!-- éŠæˆ²é é¢ -->
        <div id="page-game" class="flex-1 flex flex-col">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-black text-gray-800 tracking-tight">Corin Beauty</h1>
                <p class="text-[10px] text-pink-500 font-bold tracking-[0.3em] uppercase mt-1">Lucky Spin Wheel</p>
            </div>

            <!-- é‡è¦æé†’ -->
            <div class="bg-rose-500 text-white rounded-2xl p-3 mb-8 shadow-md border-b-4 border-rose-600">
                <div class="text-[10px] font-bold space-y-1">
                    <p class="flex items-start gap-1.5 leading-tight"><span class="shrink-0">â€¢</span> ç²çå¾Œè«‹ã€Œæˆªåœ–ä¿å­˜ã€ä»¥ä¾¿ç¾å ´æ ¸éŠ·ã€‚</p>
                    <p class="flex items-start gap-1.5 leading-tight"><span class="shrink-0">â€¢</span> å–®æ¬¡æ¶ˆè²»é™ç”¨ä¸€é …å„ªæƒ ï¼Œé€¾æœŸè‡ªå‹•å¤±æ•ˆã€‚</p>
                </div>
            </div>

            <!-- è½‰ç›¤ä¸»é«” -->
            <div id="game-area" class="flex flex-col items-center mb-8">
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <div class="center-button"><span class="text-pink-500 text-xs font-black">WIN</span></div>
                    <canvas id="wheel" width="500" height="500"></canvas>
                </div>
            </div>

            <!-- é–å®šç‹€æ…‹ -->
            <div id="locked-overlay" class="hidden flex-1 flex flex-col items-center justify-center text-center py-6 bg-gray-50 rounded-3xl mb-6 border border-dashed border-gray-200">
                <div class="text-5xl mb-4">ğŸ</div>
                <h3 id="locked-title" class="text-gray-800 font-black text-xl mb-1">ä»Šæ—¥æ¬¡æ•¸å·²ç”¨å®Œ</h3>
                <p id="locked-desc" class="text-gray-500 text-sm mb-4">åˆ†äº«å¥½å‹å¯é¡å¤–ç²å¾— 2 æ¬¡æ©Ÿæœƒ</p>
                <button id="locked-share-btn" onclick="shareToFriends()" class="px-8 py-3 bg-emerald-500 text-white rounded-full font-black shadow-lg active:scale-95 transition-transform">ğŸš€ ç«‹å³åˆ†äº«å¥½å‹</button>
            </div>

            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <div id="footer-controls" class="mt-auto space-y-4">
                <button id="btn-spin" onclick="spinWheel()" class="w-full py-4 bg-pink-600 text-white rounded-2xl text-sm font-black shadow-lg active:scale-95 transition-all disabled:opacity-50 disabled:bg-gray-300">
                    ç«‹å³æŠ½ç (å‰©é¤˜ <span id="remaining-count">0</span> æ¬¡)
                </button>
                <div class="text-center pt-2">
                    <button onclick="handleReservation()" class="text-pink-500 font-bold text-sm hover:underline">æ‰‹åˆ€é ç´„å°ˆå±¬èª²ç¨‹ â”</button>
                </div>
            </div>
        </div>

        <!-- ç´€éŒ„é é¢ -->
        <div id="page-history" class="hidden flex-1 flex flex-col overflow-hidden">
            <h2 class="text-lg font-black text-gray-800 mb-2">æˆ‘çš„çé …ç´€éŒ„</h2>
            
            <div class="flex gap-2 mb-4">
                <div class="flex-1 bg-emerald-50 border border-emerald-100 rounded-xl p-2 text-center">
                    <div id="count-valid" class="text-emerald-600 font-black text-lg leading-tight">0</div>
                    <div class="text-[9px] text-emerald-500 font-bold uppercase">æœ‰æ•ˆ/æœªä½¿ç”¨</div>
                </div>
                <div class="flex-1 bg-gray-50 border border-gray-100 rounded-xl p-2 text-center">
                    <div id="count-invalid" class="text-gray-400 font-black text-lg leading-tight">0</div>
                    <div class="text-[9px] text-gray-400 font-bold uppercase">éæœŸ/å·²ä½¿ç”¨</div>
                </div>
            </div>

            <div id="history-list" class="flex-1 overflow-y-auto space-y-6 pr-1"></div>
        </div>

        <!-- åº•éƒ¨è³‡è¨Š -->
        <div class="mt-6 pt-4 border-t border-gray-50">
            <div class="flex justify-between items-center mb-2">
                <p id="countdown-timer" class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">RESET IN: --:--:--</p>
                <span id="user-id-display" onclick="openAdmin()" class="text-[9px] text-gray-300 font-mono cursor-pointer">UID: ----</span>
            </div>
            <p class="text-[10px] text-gray-400 font-bold text-center tracking-widest uppercase">System By Corin</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Gemini API Configuration
        const apiKey = ""; // Runtime provides this
        const geminiModel = "gemini-2.5-flash-preview-09-2025";

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyB48QgamPtCi6o44ymd-2E1VLCrzWEkM_0",
            authDomain: "corin-beauty-app.firebaseapp.com",
            projectId: "corin-beauty-app",
            storageBucket: "corin-beauty-app.firebasestorage.app",
            messagingSenderId: "364585149363",
            appId: "1:364585149363:web:779df52c038f328f439kcl"
        };

        const INITIAL_CHANCES = 3;
        const SHARE_BONUS = 2;
        const EXPIRY_DAYS = 7;

        const PRIZE_POOL = [
            { id: 1, name: "1çï¼ç•¶æ—¥ç•¶æ¬¡æ¶ˆè²» 5 æŠ˜", weight: 2, color: "#fdf2f8", text: "#db2777" },
            { id: 2, name: "2çï¼ç•¶æ—¥ç•¶æ¬¡æ¶ˆè²» 7 æŠ˜", weight: 4, color: "#ffffff", text: "#ec4899" },
            { id: 3, name: "3çï¼ç•¶æ—¥ç•¶æ¬¡æ¶ˆè²» 75 æŠ˜", weight: 4, color: "#fdf2f8", text: "#db2777" },
            { id: 4, name: "4çï¼æš—æ²‰æ°æ°å–®éƒ¨ä½ä¸‰å ‚ $899", weight: 30, color: "#ffffff", text: "#ec4899" },
            { id: 5, name: "5çï¼è…‹ä¸‹é™¤æ¯›ä¸€å ‚å„ªæƒ åƒ¹ $99", weight: 50, color: "#fdf2f8", text: "#db2777" },
            { id: 6, name: "6çï¼å…è²»é™¤æ¯›å°ˆç”¨ä¹³æ¶² 50ml", weight: 2, color: "#ffffff", text: "#ec4899" },
            { id: 7, name: "7çï¼ç¾æŠ˜ 100 å…ƒ", weight: 70, color: "#fdf2f8", text: "#db2777" },
            { id: 8, name: "8çï¼ç¾æŠ˜ 50 å…ƒ", weight: 80, color: "#ffffff", text: "#ec4899" },
            { id: 9, name: "9çï¼éšé¡æ·±å±¤è­·è†šèª²ç¨‹ $899", weight: 40, color: "#fdf2f8", text: "#db2777" },
            { id: 10, name: "10çï¼ç«æ¯›ç®¡ç† $699", weight: 40, color: "#ffffff", text: "#ec4899" }
        ];

        let state = {
            count: 0,
            bonusCount: 0,
            lastPlayedDate: '',
            hasSharedToday: false,
            prizes: []
        };

        let isSpinning = false;
        let currentRotation = 0;
        let lastPrizeName = "";

        // --- Optimized Gemini AI Function with Exponential Backoff ---
        window.getBeautyAdvice = async function() {
            if (!lastPrizeName) return;

            const aiSection = document.getElementById('ai-consultant-section');
            const aiLoading = document.getElementById('ai-loading');
            const aiResponse = document.getElementById('ai-response');
            const askBtn = document.getElementById('btn-ask-ai');

            aiSection.classList.remove('hidden');
            aiLoading.classList.remove('hidden');
            aiResponse.classList.add('hidden');
            askBtn.disabled = true;

            const systemPrompt = "ä½ æ˜¯ä¸€ä½ Corin Beauty çš„å°ˆæ¥­ç¾é¡é¡§å•ã€‚èªªè©±è¦ªåˆ‡ã€å°ˆæ¥­ã€å……æ»¿ç†±æƒ…ã€‚è«‹é‡å°ä¸­ççé …ï¼Œæä¾› 100 å­—å…§çš„å°ˆæ¥­ç™‚ç¨‹è§£èªªèˆ‡æ—¥å¸¸ä¿é¤Šå»ºè­°ã€‚";
            const userQuery = `æˆ‘æŠ½ä¸­äº†ã€Œ${lastPrizeName}ã€ï¼Œè«‹çµ¦æˆ‘ä¸€äº›å°ˆæ¥­çš„å»ºè­°èˆ‡ç™‚ç¨‹èªªæ˜ã€‚`;

            const callWithRetry = async (retries = 5) => {
                let delay = 1000;
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userQuery }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] }
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            return data.candidates?.[0]?.content?.parts?.[0]?.text;
                        }
                    } catch (err) {
                        // Silent fail for retry
                    }
                    
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff: 1s, 2s, 4s, 8s, 16s
                    }
                }
                throw new Error("Connection failed after retries");
            };

            try {
                const advice = await callWithRetry();
                aiResponse.innerText = advice || "é¡§å•ç›®å‰æ­£å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                aiResponse.classList.remove('hidden');
            } catch (e) {
                aiResponse.innerText = "é€£ç·šé¡§å•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªç¶²è·¯ç©©å®šæˆ–é‡æ–°æ•´ç†é é¢ã€‚";
                aiResponse.classList.remove('hidden');
            } finally {
                aiLoading.classList.add('hidden');
            }
        };

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                loadData();
                drawWheel();
                updateUI();
                startTimer();
                document.getElementById('status-overlay').classList.add('hidden');
            } catch (error) {
                document.getElementById('loading-ui').classList.add('hidden');
                document.getElementById('error-ui').classList.remove('hidden');
                document.getElementById('error-message').textContent = "é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯ç’°å¢ƒã€‚";
            }
        }

        function loadData() {
            const saved = localStorage.getItem('corin_wheel_v1');
            const today = new Date().toDateString();
            if (saved) {
                state = JSON.parse(saved);
                if (state.lastPlayedDate !== today) {
                    state.count = 0;
                    state.bonusCount = 0;
                    state.hasSharedToday = false;
                    state.lastPlayedDate = today;
                }
            } else {
                state.lastPlayedDate = today;
            }
            if (!localStorage.getItem('corin_uid')) {
                localStorage.setItem('corin_uid', Math.random().toString(36).substring(2, 8).toUpperCase());
            }
            document.getElementById('user-id-display').innerText = `UID: ${localStorage.getItem('corin_uid')}`;
            saveData();
        }

        function saveData() { localStorage.setItem('corin_wheel_v1', JSON.stringify(state)); }

        function drawWheel() {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = centerX - 10;
            const sliceAngle = (2 * Math.PI) / 10;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            PRIZE_POOL.forEach((prize, i) => {
                const angle = i * sliceAngle;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, angle, angle + sliceAngle);
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.strokeStyle = '#fce7f3';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = prize.text;
                ctx.font = "bold 24px 'Noto Sans TC'";
                ctx.fillText(`${prize.id} ç`, radius - 30, 10);
                ctx.restore();
            });
        }

        window.spinWheel = function() {
            if (isSpinning) return;
            
            const totalMax = INITIAL_CHANCES + state.bonusCount;
            if (state.count >= totalMax) return;

            isSpinning = true;
            document.getElementById('btn-spin').disabled = true;

            const prizeIndex = getWeightedPrizeIndex();
            const prize = PRIZE_POOL[prizeIndex];

            const sliceSize = 360 / 10;
            const targetPosInWheel = (prizeIndex * sliceSize) + (sliceSize / 2);
            const targetRotation = (270 - targetPosInWheel + 360) % 360;

            const currentMod = currentRotation % 360;
            const additionalDegrees = (targetRotation - currentMod + 360) % 360;
            const totalSpinToAdd = (360 * 8) + additionalDegrees; 
            
            currentRotation += totalSpinToAdd;

            const wheel = document.getElementById('wheel');
            wheel.style.transform = `rotate(${currentRotation}deg)`;

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('btn-spin').disabled = false;
                showPrizeResult(prize);
            }, 4100);
        };

        function getWeightedPrizeIndex() {
            const totalWeight = PRIZE_POOL.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            for (let i = 0; i < PRIZE_POOL.length; i++) {
                if (random < PRIZE_POOL[i].weight) return i;
                random -= PRIZE_POOL[i].weight;
            }
            return PRIZE_POOL.length - 1;
        }

        function showPrizeResult(prize) {
            const now = Date.now();
            const exp = now + (EXPIRY_DAYS * 86400000);
            const win = {
                id: Math.random().toString(36).substring(2, 9).toUpperCase(),
                name: prize.name,
                winDate: now,
                expDate: exp,
                isRedeemed: false
            };

            state.prizes.push(win);
            state.count++;
            lastPrizeName = prize.name;
            saveData();
            updateUI();

            document.getElementById('ai-consultant-section').classList.add('hidden');
            document.getElementById('ai-response').classList.add('hidden');
            const askBtn = document.getElementById('btn-ask-ai');
            askBtn.disabled = false;

            document.getElementById('modal-prize-name').innerText = win.name;
            document.getElementById('modal-prize-id').innerText = `æ ¸éŠ·åºè™Ÿ: ${win.id}`;
            document.getElementById('modal-prize-exp').innerText = `æœ‰æ•ˆè‡³: ${new Date(exp).toLocaleDateString()}`;
            document.getElementById('prize-modal').classList.add('modal-active');

            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#ec4899', '#f472b6', '#fbbf24']
            });
        }

        window.updateUI = function() {
            const totalMax = INITIAL_CHANCES + state.bonusCount;
            const remaining = Math.max(0, totalMax - state.count);
            const isLocked = remaining <= 0 && !isSpinning;

            document.getElementById('remaining-count').innerText = remaining;
            
            if (isLocked) {
                document.getElementById('game-area').classList.add('hidden');
                document.getElementById('footer-controls').classList.add('hidden');
                document.getElementById('locked-overlay').classList.remove('hidden');
                const btnEl = document.getElementById('locked-share-btn');
                if (state.hasSharedToday) {
                    document.getElementById('locked-title').innerText = "ä»Šæ—¥æ¬¡æ•¸å·²ç”¨å®Œ";
                    document.getElementById('locked-desc').innerText = "è«‹æ˜æ—¥å†ä¾†ï¼";
                    btnEl.classList.add('hidden');
                }
            } else {
                document.getElementById('game-area').classList.remove('hidden');
                document.getElementById('footer-controls').classList.remove('hidden');
                document.getElementById('locked-overlay').classList.add('hidden');
            }

            const dots = document.getElementById('chance-dots');
            dots.innerHTML = '';
            for(let i=0; i<5; i++) {
                const dot = document.createElement('div');
                dot.className = `w-1.5 h-1.5 rounded-full ${i < state.count ? 'bg-pink-500' : 'bg-gray-200'}`;
                dots.appendChild(dot);
            }
        }

        window.switchTab = function(t) {
            const isGame = t === 'game';
            document.getElementById('page-game').classList.toggle('hidden', !isGame);
            document.getElementById('page-history').classList.toggle('hidden', isGame);
            document.getElementById('tab-game').className = isGame ? 'px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow-sm text-pink-600' : 'px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-400';
            document.getElementById('tab-history').className = !isGame ? 'px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow-sm text-pink-600' : 'px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-400';
            if(!isGame) renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            const now = Date.now();

            const validPrizes = state.prizes.filter(p => !p.isRedeemed && now <= p.expDate);
            const invalidPrizes = state.prizes.filter(p => p.isRedeemed || now > p.expDate);

            document.getElementById('count-valid').innerText = validPrizes.length;
            document.getElementById('count-invalid').innerText = invalidPrizes.length;

            if(state.prizes.length === 0) {
                list.innerHTML = '<div class="py-12 text-center text-gray-400 text-sm">å°šæœªæœ‰ä¸­çç´€éŒ„</div>';
                return;
            }

            if (validPrizes.length > 0) {
                const validSection = document.createElement('div');
                validSection.innerHTML = `<div class="flex items-center gap-2 mb-3"><div class="h-4 w-1 bg-pink-500 rounded-full"></div><h3 class="text-xs font-black text-gray-800 uppercase tracking-widest">å¯ç”¨çé …</h3></div>`;
                [...validPrizes].reverse().forEach(p => validSection.appendChild(createPrizeCard(p, false)));
                list.appendChild(validSection);
            }

            if (invalidPrizes.length > 0) {
                const invalidSection = document.createElement('div');
                invalidSection.className = "mt-8";
                invalidSection.innerHTML = `<div class="flex items-center gap-2 mb-3"><div class="h-4 w-1 bg-gray-300 rounded-full"></div><h3 class="text-xs font-black text-gray-400 uppercase tracking-widest">æ­·å²ç´€éŒ„</h3></div>`;
                [...invalidPrizes].reverse().forEach(p => invalidSection.appendChild(createPrizeCard(p, true)));
                list.appendChild(invalidSection);
            }
        }

        function createPrizeCard(p, isInvalid) {
            const now = Date.now();
            const isExpired = now > p.expDate && !p.isRedeemed;
            const card = document.createElement('div');
            card.className = `p-4 rounded-2xl border mb-3 transition-all ${isInvalid ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-pink-100 shadow-sm'}`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[9px] text-gray-400 font-mono">ID: ${p.id}</span>
                    <span class="text-[10px] font-bold ${p.isRedeemed ? 'text-gray-400' : (isExpired ? 'text-rose-400' : 'text-emerald-500')}">
                        ${p.isRedeemed ? 'å·²ä½¿ç”¨' : (isExpired ? 'å·²é€¾æœŸ' : 'æœ‰æ•ˆ')}
                    </span>
                </div>
                <div class="font-bold text-gray-800 text-sm mb-2">${p.name}</div>
                <div class="flex justify-between items-end">
                    <span class="text-[9px] text-gray-400">æœ‰æ•ˆè‡³: ${new Date(p.expDate).toLocaleDateString()}</span>
                    ${(!p.isRedeemed && !isExpired) ? `<button onclick="redeem('${p.id}')" class="px-4 py-1.5 bg-pink-600 text-white rounded-lg text-xs font-bold shadow-md active:scale-95">å…Œæ›</button>` : ''}
                </div>
            `;
            return card;
        }

        window.redeem = function(id) {
            const p = state.prizes.find(x => x.id === id);
            if(!p) return;
            document.getElementById('redeem-confirm-modal').classList.add('modal-active');
            document.getElementById('confirm-redeem-btn').onclick = () => {
                p.isRedeemed = true;
                saveData(); renderHistory(); closeModal('redeem-confirm-modal');
            };
        }

        window.shareToFriends = async function() {
            try {
                const text = "æˆ‘åœ¨ Corin Beauty å¹¸é‹è½‰ç›¤æŠ½ä¸­äº†è¶…æ£’å¥½ç¦®ï¼ä½ ä¹Ÿå¿«ä¾†åƒåŠ ï¼";
                const url = window.location.href;
                if (navigator.share) await navigator.share({ title: 'Corin Beauty', text, url });
                else { await navigator.clipboard.writeText(`${text} ${url}`); showMsg("é€£çµå·²è¤‡è£½è‡³å‰ªè²¼ç°¿ï¼"); }
                
                if (!state.hasSharedToday) {
                    state.bonusCount += SHARE_BONUS; state.hasSharedToday = true;
                    saveData(); updateUI(); showMsg("ğŸ æ„Ÿè¬åˆ†äº«ï¼å·²è´ˆé€ 2 æ¬¡æ©Ÿæœƒ");
                }
            } catch (err) {}
        }

        window.openAdmin = function() {
            document.getElementById('admin-pass').value = "";
            document.getElementById('admin-modal').classList.add('modal-active');
        };

        window.verifyAdmin = function() {
            if (document.getElementById('admin-pass').value === "1016") {
                state.count = 0; state.bonusCount = 0; state.hasSharedToday = false;
                saveData(); updateUI(); closeModal('admin-modal');
                showMsg("âœ… ç³»çµ±å·²é‡ç½®æ¬¡æ•¸");
            } else { showMsg("âŒ å¯†ç¢¼éŒ¯èª¤"); }
        }

        window.showMsg = function(text) {
            document.getElementById('msg-text').innerText = text;
            document.getElementById('msg-modal').classList.add('modal-active');
        };

        window.closeModal = function(id) { document.getElementById(id).classList.remove('modal-active'); };
        window.handleReservation = function() { window.open("https://lin.ee/EeqKZ4u", "_blank"); };

        function startTimer() {
            const el = document.getElementById('countdown-timer');
            const tick = () => {
                const now = new Date();
                const mid = new Date(); mid.setHours(23, 59, 59, 999);
                const diff = mid - now;
                if(diff <= 0) { location.reload(); return; }
                const h = String(Math.floor(diff/3600000)).padStart(2,'0');
                const m = String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
                const s = String(Math.floor((diff%60000)/1000)).padStart(2,'0');
                el.innerText = `RESET IN: ${h}:${m}:${s}`;
            };
            tick(); setInterval(tick, 1000);
        }

        initApp();
    </script>
</body>
</html>
